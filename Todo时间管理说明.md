# Blinko Todo 开始结束时间管理

## 概述

Blinko Todo 日历同步系统支持智能识别和管理 Todo 任务的开始和结束时间，并将其转换为 ICS 日历格式。系统采用多层级时间解析策略，**专门针对东八区（北京时间）进行优化**，确保最大程度地捕获和利用时间信息。

### 核心特性
- 🕐 **东八区时间基准**：所有时间输入按照北京时间（UTC+8）解析
- 🔄 **智能时区转换**：自动处理时区偏移，确保跨平台时间一致性
- 📅 **多格式支持**：支持时间范围、单独时间、完整日期时间等格式
- 🌏 **标准兼容**：生成符合 RFC 5545 标准的 ICS 文件，包含完整时区信息
- ⚡ **优化的时间处理**：使用专门的 CSTTimeHandler 工具类确保精确的东八区时间处理

## 东八区时间处理工具类

### CSTTimeHandler 类

系统引入了专门的 `CSTTimeHandler` 工具类来处理东八区时间转换和格式化：

```javascript
class CSTTimeHandler {
  // 东八区偏移量（8小时，单位毫秒）
  static CST_OFFSET = 8 * 60 * 60 * 1000;
  
  // 核心方法：
  static createCSTTime(year?, month?, day?, hour?, minute?) // 创建东八区时间
  static toCSTTime(date) // 将任意时间转换为东八区时间基准
  static parseTimeInCST(timeString, baseDate) // 解析时间字符串为东八区时间
  static parseDateTimeInCST(year, month, day, hour, minute) // 解析日期时间为东八区时间
  static now() // 获取当前东八区时间
}
```

### 时间处理优势

1. **精确的时区处理**：确保所有解析的时间都按照东八区标准处理
2. **跨环境一致性**：无论Worker运行在哪个时区，都能正确处理东八区时间
3. **智能时区转换**：自动处理UTC和东八区之间的转换
4. **标准化接口**：提供统一的时间处理接口，减少时区相关错误

## 时间获取策略

### 优先级顺序

系统按照以下优先级顺序解析 Todo 的时间信息：

1. **API 直接字段** (最高优先级)
2. **Metadata 字段**
3. **内容文本解析**
4. **默认时间** (最低优先级)

## 详细解析方式

### 1. API 直接字段

系统首先检查 Blinko API 返回的 Todo 对象中的直接时间字段：

```javascript
// 检查 API 返回的时间字段
if (todo.startDate) {
  startTime = new Date(todo.startDate);
  timeSource = 'api_startDate';
}

if (todo.endDate) {
  endTime = new Date(todo.endDate);
  timeSource = 'api_both'; // 如果同时有开始和结束时间
}
```

**支持的字段：**
- `todo.startDate`: 任务开始时间
- `todo.endDate`: 任务结束时间

### 2. Metadata 字段解析

如果 API 直接字段不存在，系统会检查 `metadata` 对象中的时间信息：

```javascript
if (todo.metadata && typeof todo.metadata === 'object') {
  if (todo.metadata.startDate) {
    startTime = new Date(todo.metadata.startDate);
    timeSource = 'metadata_startDate';
  }
  
  if (todo.metadata.endDate) {
    endTime = new Date(todo.metadata.endDate);
    timeSource = 'metadata_both';
  }
}
```

**支持的字段：**
- `todo.metadata.startDate`: 元数据中的开始时间
- `todo.metadata.endDate`: 元数据中的结束时间

### 3. 内容文本解析

系统支持从 Todo 内容文本中智能解析多种时间格式：

#### 3.1 时间范围格式

**格式：** `HH:MM-HH:MM`

**示例：**
```
* [ ] 9:00-10:00 会议讨论      # 北京时间上午9点到10点
* [ ] 14:30-16:00 项目评审     # 北京时间下午2点半到4点
* [ ] 8:00-9:30 晨练          # 北京时间早上8点到9点半
```

**解析规则：**
- **时区基准**：所有时间按照东八区（北京时间）解析
- **日期基准**：使用 Todo 创建日期，设置具体的开始和结束时间
- **跨天处理**：如果结束时间早于开始时间，自动假设跨天（结束时间 +1 天）
- **时区保持**：解析后的时间保持东八区属性，在生成 ICS 时正确转换

#### 3.2 单独时间格式

**格式：** `HH:MM`

**示例：**
```
* [ ] 14:00 客户电话          # 北京时间下午2点，持续1小时
* [ ] 9:30 站会              # 北京时间上午9点半，持续1小时  
* [ ] 20:00 学习英语          # 北京时间晚上8点，持续1小时
```

**解析规则：**
- **时区基准**：按照东八区（北京时间）解析时间
- **开始时间**：使用指定时间作为开始时间
- **默认持续**：自动设置持续 1 小时
- **日期继承**：使用 Todo 的创建日期作为日期基准

#### 3.3 日期时间格式

**格式：** `YYYY-MM-DD HH:MM`

**示例：**
```
* [ ] 2024-01-15 14:00 重要会议    # 2024年1月15日北京时间下午2点
* [ ] 2024-02-20 9:30 医生预约     # 2024年2月20日北京时间上午9点半
* [ ] 2024-03-10 16:00 项目截止    # 2024年3月10日北京时间下午4点
```

**解析规则：**
- **完整解析**：使用完整的日期和时间作为开始时间
- **时区处理**：所有时间按照东八区（北京时间）处理
- **默认持续**：自动设置持续 1 小时
- **精确定位**：支持跨月份、跨年度的时间安排

### 4. 默认时间策略

当所有解析方式都无法获取时间信息时，系统使用默认策略：

- **开始时间：** Todo 的创建时间 (`todo.createdAt`)
- **结束时间：** 开始时间 + 1 小时
- **备用时间：** 如果创建时间不存在，使用更新时间 (`todo.updatedAt`)

## 时间验证与修正

### 有效性检查

```javascript
// 确保时间有效且结束时间不早于开始时间
if (!startTime || isNaN(startTime.getTime())) {
  startTime = created;
}
if (!endTime || isNaN(endTime.getTime()) || endTime <= startTime) {
  endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // +1小时
}
```

### 修正规则

1. **无效时间修正：** 如果解析出的时间无效，回退到创建时间
2. **时间顺序修正：** 如果结束时间早于或等于开始时间，自动设置为开始时间 + 1小时
3. **跨天处理：** 对于时间范围格式，如果结束时间小于开始时间，自动假设跨天

## 东八区时间处理

### 时间解析策略

系统采用东八区（北京时间）作为基准时区进行时间解析：

1. **输入时间解析**：所有从内容中解析的时间（如 `9:00-10:00`）都按照东八区时间处理
2. **API 时间字段**：来自 Blinko API 的时间字段保持原有时区信息
3. **默认时间**：Todo 创建时间和更新时间按照系统时区（东八区）处理

### 时区转换机制

```javascript
// 东八区时间解析示例
const parseTimeInCST = (timeString, baseDate) => {
  // 解析如 "14:00" 的时间，按照东八区处理
  const [hour, minute] = timeString.split(':');
  const cstTime = new Date(baseDate);
  cstTime.setHours(parseInt(hour), parseInt(minute), 0, 0);
  return cstTime; // 自动包含东八区偏移
};
```

## ICS 日历格式输出

系统将解析后的时间信息转换为标准的 ICS 格式，确保正确的时区处理：

```javascript
// ICS 文件头部时区定义
'X-WR-TIMEZONE:Asia/Shanghai',
'BEGIN:VTIMEZONE',
'TZID:Asia/Shanghai',
'TZOFFSETFROM:+0800',
'TZOFFSETTO:+0800',
'TZNAME:CST',

// 时间格式化（转换为 UTC 但保留时区信息）
const formatDate = (date: Date) => {
  return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
};

// 在ICS事件中使用
`DTSTART:${formatDate(startTime)}`,
`DTEND:${formatDate(endTime)}`,
```

**东八区时间处理特点：**
- **输入解析**：按照北京时间（UTC+8）解析所有时间
- **内部存储**：转换为 UTC 格式但包含完整时区信息
- **ICS 输出**：符合 RFC 5545 标准，包含 Asia/Shanghai 时区定义
- **客户端显示**：日历应用根据时区定义自动转换为用户本地时间

## 调试和监控

### 时间来源追踪

系统记录每个 Todo 的时间来源，便于调试：

- `default`: 使用默认时间
- `api_startDate`: API 提供开始时间
- `api_endDate`: API 提供结束时间  
- `api_both`: API 提供开始和结束时间
- `metadata_startDate`: Metadata 提供开始时间
- `metadata_endDate`: Metadata 提供结束时间
- `metadata_both`: Metadata 提供开始和结束时间
- `content_time_range`: 从内容解析时间范围
- `content_single_time`: 从内容解析单个时间
- `content_date_time`: 从内容解析日期时间

### 日志记录

系统在处理过程中会记录详细的解析日志，包括：
- 原始内容
- 解析结果
- 时间来源
- 最终使用的时间

## 最佳实践

### 为 Todo 添加时间信息

1. **推荐格式（均按北京时间）：**
   ```
   * [ ] 9:00-10:00 团队会议        # 北京时间上午9-10点
   * [ ] 2024-01-15 14:00 客户演示  # 指定日期的北京时间下午2点
   * [ ] 15:30 代码评审             # 北京时间下午3点半，持续1小时
   * [ ] 8:30-9:00 晨会             # 北京时间早上8点半到9点
   * [ ] 21:00-22:30 学习时间       # 北京时间晚上9点到10点半
   ```

2. **避免的格式：**
   ```
   * [ ] 明天开会 (无具体时间)
   * [ ] 大概下午 (时间模糊)
   * [ ] 9点左右 (格式不标准)
   * [ ] 3:00 PM 会议 (非24小时制)
   * [ ] 14:00 EST 电话 (包含其他时区)
   ```

3. **特殊场景处理：**
   ```
   * [ ] 23:30-1:00 深夜工作       # 自动识别跨天，结束时间为次日1点
   * [ ] 2024-12-25 0:00 元旦活动  # 支持跨年时间安排
   * [ ] 6:00-7:30 晨练           # 早间时间安排
   ```

### 东八区时间注意事项

#### 时间解析
- **输入时间**：所有手动输入的时间（如 `9:00`、`14:30-16:00`）都按照北京时间解析
- **API 时间**：来自 Blinko API 的时间字段保持原有时区信息
- **创建时间**：Todo 的创建和更新时间使用系统时区（东八区）

#### 存储和传输
- **内部处理**：系统内部使用 JavaScript Date 对象，自动处理时区偏移
- **ICS 格式**：输出为 UTC 时间但包含 `Asia/Shanghai` 时区定义
- **标准兼容**：符合 RFC 5545 ICS 标准，确保跨平台兼容性

#### 显示效果
- **日历应用**：会自动根据 ICS 文件中的时区信息显示正确的本地时间
- **时间一致性**：确保在不同设备和不同时区下显示的时间都是正确的北京时间
- **夏令时处理**：自动处理夏令时变化（虽然中国不使用夏令时）

### 性能优化

- 时间解析采用正则表达式，性能高效
- 支持批量处理多个 Todo
- 缓存机制确保重复请求的快速响应

## 故障排除

### 常见问题

1. **时间显示不正确**
   - 检查原始 Todo 内容的时间格式是否符合北京时间标准
   - 确认日历应用是否正确识别 Asia/Shanghai 时区
   - 验证设备的系统时区设置
   - 检查日历应用的时区显示设置

2. **东八区时间解析失败**
   - 确认时间格式是否为 24 小时制（如 `14:00` 而非 `2:00 PM`）
   - 检查是否包含了不支持的时区标识（如 EST、PST 等）
   - 验证日期格式是否为 `YYYY-MM-DD` 标准格式
   - 查看系统日志中的时间来源和解析结果

3. **跨天时间问题**
   - 确认跨天时间范围的逻辑（如 `23:30-1:00` 应理解为到次日1点）
   - 检查是否正确处理了日期边界
   - 验证长时间跨度的任务设置

4. **日历同步时区偏差**
   - 确认 ICS 文件中的时区定义是否正确
   - 检查日历应用对 Asia/Shanghai 时区的支持
   - 验证 Worker 部署地区的时间设置
   - 测试不同日历应用的兼容性

### 调试步骤

1. **系统状态检查**
   - 检查 Worker Dashboard 的同步状态
   - 确认 Worker 部署在正确的地区
   - 验证系统时间与北京时间的一致性

2. **时间解析验证**
   - 查看生成的 ICS 文件内容，确认时区定义
   - 验证原始 Todo 数据的时间字段格式
   - 测试时间解析正则表达式的匹配结果
   - 检查时间来源标记（timeSource）

3. **客户端测试**
   - 确认日历应用的导入设置
   - 测试不同日历应用的显示效果
   - 验证时区自动转换功能
   - 检查跨天任务的显示正确性

4. **时区一致性验证**
   ```javascript
   // 测试当前时间是否正确解析为北京时间
   const testTime = new Date('2024-01-15 14:00');
   console.log('解析时间:', testTime.toString());
   console.log('UTC时间:', testTime.toISOString());
   console.log('北京时间:', testTime.toLocaleString('zh-CN', {timeZone: 'Asia/Shanghai'}));
   ```

## 更新日志

- **v1.0.0**: 初始版本，支持基本时间解析
- **v1.1.0**: 添加 Metadata 字段支持
- **v1.2.0**: 增强内容文本解析能力
- **v1.3.0**: 添加时间验证和修正机制
- **v1.4.0**: 优化 ICS 格式输出和时区处理
- **v1.5.0**: **强化东八区时间处理**
  - 明确所有时间输入按照北京时间（UTC+8）解析
  - 优化时区转换机制和显示逻辑
  - 增强跨天时间处理能力
  - 完善时区兼容性和调试功能
  - 更新文档示例，全面支持中国标准时间

## 实际使用示例

### 东八区时间处理示例

假设您在北京时间下午 3 点创建了以下 Todo：

```markdown
* [ ] 9:00-10:00 团队晨会
* [ ] 14:30 客户电话
* [ ] 2024-01-20 16:00 项目评审
* [ ] 23:30-1:00 深夜开发
```

**系统处理流程：**

1. **时间解析**（按北京时间）
   - `9:00-10:00` → 北京时间今日上午 9:00 至 10:00
   - `14:30` → 北京时间今日下午 2:30 至 3:30（默认1小时）
   - `2024-01-20 16:00` → 北京时间 2024年1月20日 下午 4:00 至 5:00
   - `23:30-1:00` → 北京时间今日 23:30 至明日 1:00（自动跨天）

2. **ICS 文件生成**
   ```ics
   BEGIN:VCALENDAR
   X-WR-TIMEZONE:Asia/Shanghai
   TZID:Asia/Shanghai
   TZOFFSETFROM:+0800
   TZOFFSETTO:+0800
   
   BEGIN:VEVENT
   DTSTART:20240115T010000Z  # UTC时间：01:00（对应北京时间09:00）
   DTEND:20240115T020000Z    # UTC时间：02:00（对应北京时间10:00）
   SUMMARY:团队晨会
   END:VEVENT
   END:VCALENDAR
   ```

3. **日历显示效果**
   - 在北京的用户：显示为北京时间 9:00-10:00
   - 在纽约的用户：显示为当地时间（自动转换）
   - 在伦敦的用户：显示为当地时间（自动转换）

### 时区一致性验证

无论您在世界任何地方访问日历，系统都会确保：
- ✅ 原定的北京时间 9:00 会议始终显示为正确的本地对应时间
- ✅ 跨时区团队成员看到的是同一个会议的本地时间
- ✅ 时间不会因为设备或应用的时区设置而发生偏移

这样的设计确保了基于北京时间的工作安排能够准确地在全球范围内同步和显示。 